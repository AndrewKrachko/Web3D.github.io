<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Babylon Template</title>

    <style>
        html,
        body {
            overflow: auto;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        div {
            overflow: hidden;
        }
        
        .visible {
            visibility: visible;
        }
        
        .not-visible {
            visibility: hidden;
        }
    </style>

    <script src="https://preview.babylonjs.com/babylon.js"></script>
    <!-- <script src="https://github.com/BabylonJS/Babylon.js/blob/master/dist/preview%20release/loaders/babylon.stlFileLoader.js"></script> -->
    <script src="https://preview.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://code.jquery.com/pep/0.4.3/pep.js"></script>

    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://preview.babylonjs.com/gui/babylon.gui.min.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
</head>

<body>
    <h1>Квеста А</h1>
    <div>
        Все задания квеста:
        <li>
            <a href="qwestA_0.html">task 1</a>
        </li>
        <li>
            <a href="qwestA_1.html">task 1</a>
        </li>
    </div>
    <div>
        <div>
            <br> Укажите лишние элементы, которых нет на проекциях парахода.</br>
            Для перемещения камеры используйте стрелки. Вращайте камеру при помощи зажимания левой клавиши мыши и перемещения мыши.
            </p>
            <img src=".\Tracktor\1-3_Tracktor.jpg " width="400">
        </div>
        <div name="nextTask" class="not-visible">
            <p>Молодец! А теперь (если странички не открылись):</p>
            <li><b><a href="qwestA_3.html">Перейти к заданию 3</a></b></li>
            <li><a href="guideA_2.html" target="_blank">Еще раз посмотреть кусочек инструкции</a></li>
        </div>
        <div>
            <canvas id="renderCanvasA" touch-action="none" width="800" height="550" </canvas>
            <!-- touch-action="none" for best results from PEP -->

            <!--            <script src="Babylon.js"></script>
            <script src="babylon.stlFileLoader.js"></script>-->

            <script>
                var canvasA = document.getElementById("renderCanvasA"); // Get the canvas element
                var engineA = new BABYLON.Engine(canvasA, true); // Generate the BABYLON 3D engine

                /******* Add the create scene function ******/
                var createScene = function(engine, canvas) {

                    // Create the scene space
                    var scene = new BABYLON.Scene(engine);

                    var stdMaterial = new BABYLON.StandardMaterial("standardMaterial", sceneA)
                    stdMaterial.emissiveColor = new BABYLON.Color3.Gray;
                    var selectedMaterial = new BABYLON.StandardMaterial("selectedMaterial", sceneA)
                    selectedMaterial.emissiveColor = new BABYLON.Color3.Yellow;
                    var semiTransparentMaterial = new BABYLON.StandardMaterial("semiTransparentMaterial", sceneA)
                    semiTransparentMaterial.emissiveColor = new BABYLON.Color3.Yellow;
                    semiTransparentMaterial.alpha = 0.05;
                    var superCloseMaterial = new BABYLON.StandardMaterial("superCloseMaterial", sceneA)
                    superCloseMaterial.emissiveColor = new BABYLON.Color3(0.0, 0.7, 0.5);

                    // Add a camera to the scene and attach it to the canvas
                    var camera = new BABYLON.ArcRotateCamera("Camera", Math.PI / 2, Math.PI / 2, 2, new BABYLON.Vector3(0, 10, 60), scene);
                    camera.setTarget(new BABYLON.Vector3(0, 5, 0));
                    camera.attachControl(canvas, false);
                    scene.activeCamera.panningSensibility = 0;

                    // Add lights to the scene
                    var light1 = new BABYLON.PointLight("Omni", new BABYLON.Vector3(-200, 200, -1000), scene);
                    light1.diffuse = new BABYLON.Color3(0.1, 0.1, 0.1);
                    light1.specular = new BABYLON.Color3(0.1, 0.1, 0.1);
                    var light2 = new BABYLON.PointLight("Omni", new BABYLON.Vector3(200, 200, 1000), scene);
                    light2.diffuse = new BABYLON.Color3(0.1, 0.1, 0.1);
                    light2.specular = new BABYLON.Color3(0.1, 0.1, 0.1);

                    // Create the gizmo and attach to the sphere
                    var gizmo = new BABYLON.GizmoManager(scene);
                    gizmo.positionGizmoEnabled = true;

                    // Keep the gizmo fixed to world rotation
                    gizmo.updateGizmoRotationToMatchAttachedMesh = false;
                    gizmo.updateGizmoPositionToMatchAttachedMesh = true;

                    // Add and manipulate meshes in the scene
                    var assetsManager = new BABYLON.AssetsManager(scene);



                    assetsManager.onFinish = function(tasks) {
                        start();
                    };

                    var LoadEntity = function(name, meshNameToLoad, url, file, manager, meshArray, entity_number, ranPos = false, defMaterial = stdMaterial, selectable = true) {
                        var meshTask = manager.addMeshTask(name, '', url, file);

                        meshTask.onSuccess = function(task) {
                            meshArray[entity_number] = task.loadedMeshes[0];
                            meshArray[entity_number].name = name;
                            meshArray[entity_number].material = defMaterial;
                            meshArray[entity_number].actionManager = new BABYLON.ActionManager(scene);

                            if (selectable) {
                                meshArray[entity_number].actionManager
                                    .registerAction(
                                        new BABYLON.ExecuteCodeAction(
                                            BABYLON.ActionManager.OnPickTrigger,
                                            function(item) {
                                                for (var i = 0; i < scene.meshes.length; i++) {
                                                    if (!scene.meshes[i].name.startsWith("Base")) {
                                                        scene.meshes[i].material = defMaterial;
                                                    }
                                                }

                                                task.loadedMeshes[0].material = selectedMaterial;
                                            }
                                        )
                                    )
                            }

                            if (ranPos) {
                                meshArray[entity_number].position.x = getRandom(1, 50, -50);
                                meshArray[entity_number].position.y = getRandom(1, 50, -50);
                                meshArray[entity_number].position.z = getRandom(1, 50, -50);
                            } else {
                                meshArray[entity_number].position = BABYLON.Vector3.Zero();
                            }
                        }
                    }

                    var myMesh = [];

                    LoadEntity("BaseChassis_modA", "test", "Tracktor/", "Chassis_modA.STL", assetsManager, myMesh, 1, false, semiTransparentMaterial, false);
                    LoadEntity("BaseExhaust", "test", "Tracktor/", "Exhaust.STL", assetsManager, myMesh, 1, false, semiTransparentMaterial, false);
                    LoadEntity("BaseFrontWheel", "test", "Tracktor/", "FrontWheel.STL", assetsManager, myMesh, 1, false, semiTransparentMaterial, false);
                    LoadEntity("BaseRearWheel", "test", "Tracktor/", "RearWheel.STL", assetsManager, myMesh, 1, false, semiTransparentMaterial, false);
                    LoadEntity("BaseStearingWheel", "test", "Tracktor/", "StearingWheel.STL", assetsManager, myMesh, 1, false, semiTransparentMaterial, false);
                    LoadEntity("BaseEngine", "test", "Tracktor/", "Engine.STL", assetsManager, myMesh, 1, false, semiTransparentMaterial, false);
                    LoadEntity("BaseSeat", "test", "Tracktor/", "Seat.STL", assetsManager, myMesh, 1, false, semiTransparentMaterial, false);

                    // LoadEntity("Chassis_modA", "test", "Tracktor/", "Chassis_modA.STL", assetsManager, myMesh, 1, true);
                    // LoadEntity("Exhaust", "test", "Tracktor/", "Exhaust.STL", assetsManager, myMesh, 1, true);
                    // LoadEntity("FrontWheel", "test", "Tracktor/", "FrontWheel.STL", assetsManager, myMesh, 1, true);
                    // LoadEntity("RearWheel", "test", "Tracktor/", "RearWheel.STL", assetsManager, myMesh, 1, true);
                    // LoadEntity("StearingWheel", "test", "Tracktor/", "StearingWheel.STL", assetsManager, myMesh, 1, true);
                    // LoadEntity("Engine", "test", "Tracktor/", "Engine.STL", assetsManager, myMesh, 1, true);
                    // LoadEntity("Seat", "test", "Tracktor/", "Seat.STL", assetsManager, myMesh, 1, true);

                    assetsManager.load();

                    var advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
                    var button = BABYLON.GUI.Button.CreateSimpleButton("but", "Проверим");
                    button.width = 0.2;
                    button.horizontalAlignment = BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT;
                    button.verticalAlignment = BABYLON.GUI.Control.VERTICAL_ALIGNMENT_BOTTOM;
                    button.height = "40px";
                    button.color = "white";
                    button.background = "green";

                    // Keyboard events
                    button.onPointerUpObservable.add(() => {
                        var validSelectedCnt = 12;

                        for (var i = 0; i < scene.meshes.length; i++) {
                            if (scene.meshes[i].name == "EverythingElse" && scene.meshes[i].material == selectedMaterial || scene.meshes[i].name != "EverythingElse" && scene.meshes[i].material != selectedMaterial) {
                                validSelectedCnt--;
                            }
                        }

                        if (validSelectedCnt == 0) {
                            item = document.getElementsByName("nextTask");
                            item[0].classList.remove("not-visible");
                            alert("Молодец! Все правильно!");
                            window.open("guideA_1.html", );
                            window.scrollTo(0, document.body.scrollHeight);
                        } else {
                            alert("Чет как-то не очень, давай думай!");
                        }
                    });

                    advancedTexture.addControl(button);

                    scene.onDataLoadedObservable.add(() => {
                        var sceneItems = [];

                        for (var i = 0; i < scene.meshes.length; i++) {
                            if (!scene.meshes[i].name.startsWith("Base")) {
                                sceneItems.push(scene.meshes[i]);
                            } else {
                                scene.meshes[i].isPickable = false;
                            }
                        }

                        gizmo.attachableMeshes = sceneItems;
                    })

                    return scene;
                };
                /******* End of the create scene function ******/

                var sceneA = createScene(engineA, canvasA); //Call the createScene function


                // Register a render loop to repeatedly render the scene
                engineA.runRenderLoop(function() {
                    sceneA.render();
                });

                // Watch for browser/canvas resize events
                window.addEventListener("resize", function() {
                    engineA.resize();
                });

                function getRandom(precision, max, min = 0) {
                    return ((Math.floor((Math.random() * (max - min)) * Math.pow(10, precision))) / Math.pow(10, precision) + min);
                }
            </script>
            </canvas>
        </div>
    </div>
</body>

</html>